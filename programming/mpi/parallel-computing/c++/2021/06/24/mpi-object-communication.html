<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MPI Object Communication 1 | qubit-computing</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="MPI Object Communication 1" />
<meta name="author" content="Alexandros Giavaras" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Create derived data types with MPI_Type_create_struct" />
<meta property="og:description" content="Create derived data types with MPI_Type_create_struct" />
<link rel="canonical" href="https://pockerman.github.io/qubit_opus/programming/mpi/parallel-computing/c++/2021/06/24/mpi-object-communication.html" />
<meta property="og:url" content="https://pockerman.github.io/qubit_opus/programming/mpi/parallel-computing/c++/2021/06/24/mpi-object-communication.html" />
<meta property="og:site_name" content="qubit-computing" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-24T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://pockerman.github.io/qubit_opus/programming/mpi/parallel-computing/c++/2021/06/24/mpi-object-communication.html","@type":"BlogPosting","headline":"MPI Object Communication 1","dateModified":"2021-06-24T00:00:00-05:00","datePublished":"2021-06-24T00:00:00-05:00","author":{"@type":"Person","name":"Alexandros Giavaras"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pockerman.github.io/qubit_opus/programming/mpi/parallel-computing/c++/2021/06/24/mpi-object-communication.html"},"description":"Create derived data types with MPI_Type_create_struct","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/qubit_opus/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://pockerman.github.io/qubit_opus/feed.xml" title="qubit-computing" /><link rel="shortcut icon" type="image/x-icon" href="/qubit_opus/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" /><script src="https://hypothes.is/embed.js" async></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/qubit_opus/">qubit-computing</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/qubit_opus/about/">About Me</a><a class="page-link" href="/qubit_opus/projects/">Projects</a><a class="page-link" href="/qubit_opus/search/">Search</a><a class="page-link" href="/qubit_opus/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">MPI Object Communication 1</h1><p class="page-description">Create derived data types with MPI_Type_create_struct</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-24T00:00:00-05:00" itemprop="datePublished">
        Jun 24, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Alexandros Giavaras</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/qubit_opus/categories/#programming">programming</a>
        &nbsp;
      
        <a class="category-tags-link" href="/qubit_opus/categories/#MPI">MPI</a>
        &nbsp;
      
        <a class="category-tags-link" href="/qubit_opus/categories/#parallel-computing">parallel-computing</a>
        &nbsp;
      
        <a class="category-tags-link" href="/qubit_opus/categories/#C++">C++</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#-Overview"> Overview </a></li>
<li class="toc-entry toc-h2"><a href="#-MPI-Object-Communication-1"> MPI Object Communication 1 </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Derived-Datatypes">Derived Datatypes </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Example">Example </a></li>
<li class="toc-entry toc-h2"><a href="#-Summary"> Summary </a></li>
<li class="toc-entry toc-h2"><a href="#-References"> References </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-06-24-mpi-object-communication.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="-Overview">
<a class="anchor" href="#-Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="overview"></a> Overview<a class="anchor-link" href="#-Overview"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In object oriented code bases, data is typically organized into classes that wrap functionality, hide information and expose an API so that client code can utilize them. Thus, frequently, we end up in the situation where we have an object that we need to send across. MPI offers various posibilities to do so. In this post we will see  <code>MPI_Type_create_struct</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="-MPI-Object-Communication-1">
<a class="anchor" href="#-MPI-Object-Communication-1" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="ekf"></a> MPI Object Communication 1<a class="anchor-link" href="#-MPI-Object-Communication-1"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>MPI communication functions such as <code>MPI_Send/Recv</code> need as an input the type of the data that is to be communicated [1]. When dealing with primitive types like integers and floats MPI has got us covered so there isn't much we should do.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>However, frequently we want to communicate structures or objects. Sure, we can break up the structures
that need to be communicated into individual elements or arrays of elements and send these
in a series of send operations. However, this costly and rather counter productive; it breaks data encapsulation to start with.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Why it is costly, can be understood by considerin the so-called start-up latency [1]. This is the fixed cost we need to accept that includes the activation of multiple
OS layers, the network interface, and so on [1]. The result is that although the actual over-the-wire
times may be identical, the accumulation of the extra start-up latencies makes such an approach expensive to use.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>MPI has two main mechanisms that we can use to communicate structures between
heterogeneous machines [1]</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>MPI derived datatypes</li>
<li>Packing/unpacking data</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this post, we will look into how to construct MPI derived datatypes using  <code>MPI_Type_create_struct</code> and leave the second approach for another post.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Derived-Datatypes">
<a class="anchor" href="#Derived-Datatypes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Derived Datatypes<a class="anchor-link" href="#Derived-Datatypes"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The memory layout of the same data structure differs from machine to machine. MPI, in order to successfully transfer and  translate   an instance of a structure from one machine to another, it requires the following information [1]:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>The number and types of all the data members/fields.</li>
<li>The relative offset of the fields from the beginning of the structure (where to deposit data).</li>
<li>The total memory occupied by a structure, including any padding necessary to align it to specific boundaries. This is needed so that arrays of structures can be communicated.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>MPI provides utilities for describing the 
information above for a generatl datatype. Once a derived datatype is defined, a reference to this object can be used in any communication function that requires a datatype specification parameter [1].</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><strong>Remark</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Derived datatypes must be declared individually/locally in all the processes that will
employ them [1].</p>
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Two of the most commonly used functions for creating derived datatypes are [1]:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><code>MPI_Type_vector</code></li>
<li><code>MPI_Type_create_struct</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>MPI_Type_vector</code> is useful  for
extracting blocks of data from single or multidimensional arrays of a single datatype e.g. a vector.
<code>MPI_Type_create_struct</code> is the most generic of the available functions,
allowing the use of blocks made of different datatypes [1].</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Regardless of the approach used, each specification of a derived datatype must be followed by a call to the
<code>MPI_Type_commit</code> function for having MPI store the specification internally. Once
a datatype is committed, it can be used repeatedly in communication functions.
<code>MPI_Type_commit</code> takes just a single parameter, which is a reference to the
<code>MPI_Datatype</code> object [1].</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following example shows how to use <code>MPI_Type_create_struct</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example">
<a class="anchor" href="#Example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example<a class="anchor-link" href="#Example"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>#include &lt;mpi.h&gt;
#include &lt;iostream&gt;


struct Point
{
 unsigned int id;
 double x;
 double y;
};</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As already mentioned  <code>MPI_Type_create_struct</code> is rather involved so we group everything in the following function</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>void create_mpi_point(  MPI_Datatype* t){

    Point p;

    // the types the struct has
    MPI_Datatype types [3];

    types[0] = MPI_UNSIGNED;
    types[1] = MPI_DOUBLE;
    types[2] = MPI_DOUBLE;

    // get the addresses
    MPI_Aint displ[3];
    MPI_Aint off; 
    MPI_Aint base;

    displ [0] = 0 ;

    MPI_Get_address (&amp;(p.id) , &amp;base ) ;
    MPI_Get_address (&amp;(p.x) , &amp;off ) ;
    displ [1] = off- base ;
    MPI_Get_address (&amp;(p.y) , &amp;off ) ;
    displ [2] = off - base;

    int blklen [3] = {1, 1, 1} ;

    // create the type
    MPI_Type_create_struct( 3 , blklen , displ , types , t);

    // commit it
    MPI_Type_commit ( t ) ;

}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here is the main function</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>int main(int argc, char** argv){

    int rank;
    int n_procs;

    // initialize MPI. No MPI calls
    // prior to this point should be made
    MPI_Init(&amp;argc, &amp;argv);

    // what's my rank
    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);

    // how may procs
    MPI_Comm_size(MPI_COMM_WORLD, &amp;n_procs);

    if(n_procs &gt; 2){
        std::cout&lt;&lt;"Application should be run with 2 processes."&lt;&lt;std::endl;
        MPI_Abort(MPI_COMM_WORLD, EXIT_FAILURE);
    }

    // status on the receive side
    MPI_Status status;

    // all processes must commit the Point type
    MPI_Datatype mpi_point_type;

    // create the mpi point
    create_mpi_point(&amp;mpi_point_type);

    if(rank == 0){

        std::cout&lt;&lt;"Hello from process "&lt;&lt;rank&lt;&lt;" of "&lt;&lt;n_procs&lt;&lt;std::endl;

        Point p = {10, 0.5, 1.5};

        std::cout&lt;&lt;"Process "&lt;&lt;rank&lt;&lt;" sending point "
                 &lt;&lt;p.id
                 &lt;&lt;", "
                 &lt;&lt;p.x
                 &lt;&lt;", "
                 &lt;&lt;p.y
                 &lt;&lt;std::endl;

        // send a number to the worker 
        MPI_Send(&amp;p, 1, mpi_point_type, 1, 0, MPI_COMM_WORLD);

    }
    else if(rank == 1){

        // receive 
        Point p_recv;

        MPI_Recv(&amp;p_recv, 1, mpi_point_type, 0, 0, MPI_COMM_WORLD, &amp;status);

        std::cout&lt;&lt;"Process "&lt;&lt;rank&lt;&lt;" received point "
                 &lt;&lt;p_recv.id
                 &lt;&lt;", "
                 &lt;&lt;p_recv.x
                 &lt;&lt;", "
                 &lt;&lt;p_recv.y
                 &lt;&lt;std::endl;

    }



    MPI_Finalize();
    // No MPI calls beyond this point

    return 0;

}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="-Summary">
<a class="anchor" href="#-Summary" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="summary"></a> Summary<a class="anchor-link" href="#-Summary"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In summary, this post breifly touched on the issued of communicating user defined datatypes with MPI. These are usually in the form of classes or structs. Although, we could align such types with primitive types and comunicate the ensuing arrays, this is not a viable approach due to start-up latency. Furthermore, it will certainly lead to an error prone and complex code base.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>MPI provides various utilites in order to address such a situation. In this post, we saw  <code>MPI_Type_create_struct</code>. This is the most generic of the available functions,
allowing the use of blocks made of different datatypes [1].</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="-References">
<a class="anchor" href="#-References" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="refs"></a> References<a class="anchor-link" href="#-References"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li>Gerassimos Barlas, <code>Multicore and GPU Programming. An Integrated Approach</code>.</li>
</ol>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/qubit_opus/programming/mpi/parallel-computing/c++/2021/06/24/mpi-object-communication.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/qubit_opus/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/qubit_opus/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/qubit_opus/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Computing is fun (most of the times...)</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/pockerman" target="_blank" title="pockerman"><svg class="svg-icon grey"><use xlink:href="/qubit_opus/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
